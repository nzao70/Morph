<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestionnaire de fichiers Jamstack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Styles (inchangés, je les ai omis pour la clarté) -->
  <link rel="stylesheet" href="https/cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://kit.fontawesome.com/88b98d8504.js" crossorigin="anonymous"></script>
  <style>
    /* Reset et Thème */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    .light {
      background-color: #f4f7fa;
      color: #333;
    }

    .dark {
      background-color: #1e272e;
      color: #e0e0e0;
    }

    /* Conteneur principal */
    .file-manager-container {
      max-width: 900px;
      margin: auto;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      padding: 20px;
      border: 1px solid #e1e1e1;
    }

    .dark .file-manager-container {
      background-color: #2c3a47;
      border-color: #444;
    }

    /* Boutons et Formulaires */
    h1,
    h3 {
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .dark h1,
    .dark h3 {
      border-bottom-color: #444;
    }

    .actions-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 6px;
    }

    .dark .actions-bar {
      background-color: #344251;
    }

    .actions-bar form {
      margin: 0;
    }

    input[type="text"],
    input[type="file"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .dark input {
      background-color: #444;
      border-color: #666;
      color: #fff;
    }

    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s, transform 0.1s;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn-primary {
      background-color: #3498db;
      color: white;
    }

    .btn-secondary {
      background-color: #2ecc71;
      color: white;
    }

    .toggle-theme {
      float: right;
      background-color: #8e44ad;
      color: white;
    }

    /* Arborescence (la partie la plus importante) */
    #fileTree {
      margin-top: 20px;
    }

    .item-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .item-row:hover {
      background-color: #ecf0f1;
    }

    .dark .item-row:hover {
      background-color: #34495e;
    }

    .item-row.open {
      background-color: #e0eaf1;
    }

    .dark .item-row.open {
      background-color: #3a5063;
    }

    .item-name {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .item-name a {
      text-decoration: none;
      color: inherit;
    }

    .item-name a:hover {
      text-decoration: underline;
    }

    .item-actions {
      display: flex;
      gap: 8px;
      visibility: hidden;
    }

    .item-row:hover .item-actions {
      visibility: visible;
    }

    .item-actions button,
    .item-actions a button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #7f8c8d;
      padding: 5px;
    }

    .dark .item-actions button {
      color: #bdc3c7;
    }

    .item-actions button:hover {
      color: #3498db;
    }

    .item-actions a {
      text-decoration: none;
    }

    .icon {
      font-size: 18px;
      width: 20px;
      text-align: center;
    }

    .folder-icon::before {
      content: "\f07b";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      color: #f1c40f;
    }

    /* folder */
    .file-icon::before {
      content: "\f15b";
      font-family: "Font Awesome 6 Free";
      font-weight: 400;
      color: #95a5a6;
    }

    /* file */

    /* Indicateur de dossier ouvert */
    .item-row.open .folder-icon::before {
      content: "\f07c";
    }

    /* folder-open */

    /* Contenu des dossiers (indentation) */
    .folder-content {
      display: none;
      padding-left: 20px;
      border-left: 2px solid #e0e0e0;
      margin-left: 18px;
    }

    .dark .folder-content {
      border-left-color: #444;
    }



    /* ===== STYLE DE LA LIGHTBOX (AJOUTER DANS <style>) ===== */
    #lightbox-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      display: none;
      /* Changé par JS en 'flex' */
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .lightbox-content {
      position: relative;
      text-align: center;
    }

    #lightbox-image {
      max-width: 90vw;
      max-height: 80vh;
      border-radius: 4px;
      animation: lightbox-zoom 0.4s ease;
      touch-action: none;
    }

    @keyframes lightbox-zoom {
      from {
        transform: scale(0.8);
      }

      to {
        transform: scale(1);
      }
    }

    #lightbox-caption {
      margin-top: 15px;
      color: #ccc;
      font-size: 16px;
    }

    .lightbox-close,
    .lightbox-prev,
    .lightbox-next {
      cursor: pointer;
      position: absolute;
      color: white;
      font-size: 40px;
      font-weight: bold;
      transition: 0.3s;
      user-select: none;
      /* Empêche la sélection du texte des flèches */
    }

    .lightbox-close:hover,
    .lightbox-prev:hover,
    .lightbox-next:hover {
      color: #bbb;
    }

    .lightbox-close {
      top: 15px;
      right: 35px;
      font-size: 50px;
    }

    .lightbox-prev {
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
    }

    .lightbox-next {
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
    }


    /* ========================================= */
    /* ===== STYLES RESPONSIVES (POUR TOUS LES APPAREILS) ===== */
    /* ========================================= */

    /* Règle générale : la boîte principale prendra toute la largeur sur les petits écrans */
    .file-manager-container {
      width: 100%;
      max-width: 900px;
      /* Conserve la largeur max sur grand écran */
      box-sizing: border-box;
      /* S'assure que padding et border sont inclus dans la largeur */
    }


    /* ========================================= */
    /* ===== STYLES POUR LES NOUVEAUX CONTRÔLES ===== */
    /* ========================================= */

    /* Conteneur pour les options d'affichage */
    .display-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .dark .display-options {
      background-color: #344251;
    }

    .display-options>div {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Curseur pour la taille des images */
    #imageSize {
      cursor: pointer;
    }

    #imageSizeValue {
      font-weight: bold;
      min-width: 45px;
    }

    /* Classe pour cacher les aperçus d'images */
    #fileTree.hide-previews .file>img {
      display: none;
    }

    /* Style de base pour les aperçus, utilisant une variable CSS */
    .file>img {
      width: var(--preview-size, 150px);
      margin-top: 5px;
      margin-left: 30px;
      border-radius: 4px;
      cursor: pointer;
      transition: width 0.2s ease;
    }


    /* --- Styles pour l'interrupteur de la lightbox --- */
    .lightbox-switch-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: white;
      /* On le place en bas, collé au viewport */
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.5);
      padding: 8px 15px;
      border-radius: 20px;
      z-index: 1010;
      /* Au-dessus de l'image */
      user-select: none;
    }

    .lightbox-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .lightbox-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .lightbox-switch .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .lightbox-switch .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    .lightbox-switch input:checked+.slider {
      background-color: #2196F3;
    }

    .lightbox-switch input:checked+.slider:before {
      transform: translateX(26px);
    }


    /* --- Styles pour le mode "Pleine largeur" de la lightbox --- */
    #lightbox-overlay.full-width-mode {
      justify-content: flex-start; /* <<< LA CORRECTION EST ICI : Aligne le contenu en haut */
      align-items: flex-start;
      overflow-y: auto;
      /* Padding augmenté en haut pour laisser de la place au bouton "fermer" */
      padding: 60px 10px 40px 10px;
      box-sizing: border-box;
    }

    #lightbox-overlay.full-width-mode #lightbox-image {
      width: 50%;
      height: auto;
      max-width: none;
      max-height: none;
      margin: 0 auto;
    }

    /* Autorise le scroll vertical tactile en mode pleine largeur */
    #lightbox-overlay.full-width-mode #lightbox-image {
      touch-action: pan-y;
    }
    
    
    
    
    
    
    /* ===== STYLES POUR LA MODALE DE DÉPLACEMENT ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 500px;
    }
    
    .dark .modal-content {
      background-color: #2c3a47;
      color: #e0e0e0;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    
    
    
    
    
    /* A ajouter dans votre balise <style> */

    #uploadProgressContainer {
        margin-top: 15px;
        font-weight: bold;
    }
    
    .progress-bar-wrapper {
        width: 100%;
        background-color: #ecf0f1; /* Fond gris clair, comme vos .item-row:hover */
        border-radius: 4px;
        border: 1px solid #ddd;
        box-sizing: border-box;
    }
    
    #uploadProgressBar {
        width: 0%; /* Commence à 0 */
        height: 20px;
        background-color: #3498db; /* Bleu primaire de vos boutons */
        border-radius: 4px;
        text-align: center;
        color: white;
        line-height: 20px; /* Centrer le texte verticalement */
        font-size: 12px;
        transition: width 0.3s ease-in-out; /* Animation fluide */
    }
    
    /* Vous pouvez aussi ajouter une classe pour le thème sombre */
    .dark #uploadProgressContainer .progress-bar-wrapper {
        background-color: #34495e;
        border-color: #444;
    }






    /* --- Pour les écrans de type tablette et plus petits (en dessous de 768px) --- */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .file-manager-container {
        padding: 15px;
      }

      .actions-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .actions-bar form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      h1 {
        font-size: 1.8em;
      }

      .lightbox-prev,
      .lightbox-next {
        display: none;
      }

      .lightbox-prev {
        left: 5px;
      }

      .lightbox-next {
        right: 5px;
      }

      #lightbox-overlay.full-width-mode #lightbox-image {
        width: 100%;
        margin-top: 0;
      }
    }


    /* --- Pour les écrans de type smartphone (en dessous de 480px) --- */
    @media (max-width: 480px) {
      body {
        padding: 5px;
        font-size: 14px;
      }

      .file-manager-container {
        padding: 10px;
        box-shadow: none;
        border: none;
      }

      h1 {
        font-size: 1.5em;
      }

      .item-actions {
        visibility: visible;
        opacity: 0.8;
      }

      .item-row {
        flex-wrap: wrap;
        padding: 8px 5px;
      }

      .item-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: calc(100% - 100px);
      }

      .dark .file-manager-container {
        background-color: #1e272e;
      }
    }
    [data-netlify-identity-menu] { margin: 20px; }
  </style>
  <!-- Netlify Identity Widget -->
  <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body class="light">
  <!-- Conteneur pour le bouton de connexion/déconnexion -->
  <div data-netlify-identity-menu></div>

  <!-- Le reste de l'application est caché tant que l'utilisateur n'est pas connecté -->
  <div class="file-manager-container" id="app" style="display:none;">
    <button class="btn toggle-theme" onclick="toggleTheme()">Basculer</button>
    <h1>Gestionnaire de fichiers</h1>

    <div class="actions-bar">
      <div id="uploadProgressContainer" style="display: none;">
        <div>Progression de l'upload :</div>
        <div class="progress-bar-wrapper">
          <div id="uploadProgressBar"><span id="uploadProgressText">0%</span></div>
        </div>
      </div>
      <form id="uploadForm">
        <input type="file" id="files" name="files[]" multiple required>
        <select id="folderSelect" name="folder"></select>
        <button class="btn btn-primary" type="submit">Uploader Fichiers</button>
      </form>
      <form id="createFolderForm">
        <input type="text" id="newFolder" placeholder="Nouveau dossier" required>
        <button class="btn btn-secondary" type="submit">Créer Dossier</button>
      </form>
    </div>
    <h3><i class="fas fa-sitemap"></i> Arborescence</h3>
    <div id="fileTree"></div>
  </div>

  <!-- Modale de Déplacement -->
  <div id="moveModal" class="modal-overlay" style="display: none;">
      <!-- ... Structure HTML de la modale inchangée ... -->
  </div>

  <!-- Lightbox -->
  <div id="lightbox-overlay" style="display: none;">
      <!-- ... Structure HTML de la lightbox inchangée ... -->
  </div>

<script>
// ===================================================================================
// ======================= NOUVEAU BLOC DE GESTION JAVASCRIPT ========================
// ===================================================================================

let user = null; // Pour stocker l'utilisateur connecté

// Fonction pour faire des requêtes fetch sécurisées
async function authenticatedFetch(url, options = {}) {
    const token = user?.token?.access_token;
    if (!token) {
        alert("Veuillez vous connecter.");
        return Promise.reject("Non authentifié");
    }
    const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`
    };
    return fetch(url, { ...options, headers });
}

// Fonction pour gérer la réponse des fonctions Netlify
async function handleResponse(response, successMessage) {
    if (response.ok) {
        if(successMessage) alert(successMessage);
        loadTree();
        return response.json();
    } else {
        const errorData = await response.json();
        alert(`Erreur: ${errorData.message || 'Une erreur est survenue'}`);
        throw new Error(errorData.message);
    }
}


function displayTree(data, container, parentPath = "") {
    container.innerHTML = ""; // Vider avant de reconstruire
    if (!data) return;

    data.forEach(item => {
        const fullPath = item.path;
        const itemName = item.name || fullPath.split('/').pop();

        if (item.type === 'folder') {
            const folderId = 'folder-content-' + fullPath.replace(/[^a-zA-Z0-9]/g, '-');
            const folderDiv = document.createElement('div');
            folderDiv.className = 'folder';
            folderDiv.innerHTML = `
                <div class="item-row" onclick="toggleFolder('${folderId}')">
                    <span class="item-name"><i class="icon folder-icon"></i> <strong>${itemName}</strong></span>
                    <span class="item-actions">
                         <button title="Renommer" onclick="event.stopPropagation(); renameItem('${fullPath}', 'folder')"><i class="fas fa-pen"></i></button>
                         <button title="Déplacer" onclick="event.stopPropagation(); openMoveModal('${fullPath}', '${itemName}', 'folder')"><i class="fas fa-arrow-right-from-bracket"></i></button>
                         <button title="Supprimer" onclick="event.stopPropagation(); deleteItem('${fullPath}', 'folder')"><i class="fas fa-trash"></i></button>
                    </span>
                </div>`;

            const childrenContainer = document.createElement('div');
            childrenContainer.id = folderId;
            childrenContainer.className = 'folder-content';
            folderDiv.appendChild(childrenContainer);
            container.appendChild(folderDiv);

            if (item.children && item.children.length > 0) {
                displayTree(item.children, childrenContainer, fullPath);
            }
        } else {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file';
            const fileUrl = `${process.env.SITE_URL}/${fullPath}`.replace(/([^:]\/)\/+/g, "$1"); // URL publique
            const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(itemName);

            fileDiv.innerHTML = `
                <div class="item-row">
                    <span class="item-name"><i class="icon file-icon"></i> <a href="${fileUrl}" target="_blank">${itemName}</a></span>
                    <span class="item-actions">
                        <button title="Renommer" onclick="event.stopPropagation(); renameItem('${fullPath}', 'file')"><i class="fas fa-pen"></i></button>
                        <button title="Déplacer" onclick="openMoveModal('${fullPath}', '${itemName}', 'file')"><i class="fas fa-arrow-right-from-bracket"></i></button>
                        <button title="Supprimer" onclick="deleteItem('${fullPath}', 'file')"><i class="fas fa-trash"></i></button>
                    </span>
                </div>`;
            container.appendChild(fileDiv);
        }
    });
}


async function loadTree() {
    try {
        const response = await authenticatedFetch("/.netlify/functions/get-tree");
        const data = await response.json();
        const container = document.getElementById("fileTree");
        displayTree(data, container);
        populateFolderSelect();
    } catch (error) {
        console.error("Erreur lors du chargement de l'arborescence:", error);
    }
}

async function populateFolderSelect() {
    try {
        const response = await authenticatedFetch("/.netlify/functions/get-folders");
        const folderList = await response.json();
        const select = document.getElementById("folderSelect");
        select.innerHTML = `<option value="">Dossier Racine</option>`;
        folderList.forEach(folderPath => {
            const option = document.createElement("option");
            option.value = folderPath;
            option.textContent = folderPath;
            select.appendChild(option);
        });
    } catch (error) {
        console.error("Erreur chargement dossiers:", error);
    }
}

// -- Nouvelle logique d'upload --
document.getElementById("uploadForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const files = document.getElementById("files").files;
    const destinationFolder = document.getElementById("folderSelect").value;
    const progressContainer = document.getElementById('uploadProgressContainer');
    const progressBar = document.getElementById('uploadProgressBar');
    const progressText = document.getElementById('uploadProgressText');
    
    progressContainer.style.display = 'block';

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const filePath = destinationFolder ? `${destinationFolder}/${file.name}` : file.name;

        // 1. Demander une URL d'upload sécurisée à notre fonction
        const urlResponse = await authenticatedFetch('/.netlify/functions/create-upload-url', {
            method: 'POST',
            body: JSON.stringify({ path: filePath, contentType: file.type })
        });
        const { uploadUrl } = await urlResponse.json();

        // 2. Uploader le fichier directement sur S3 avec une barre de progression
        await new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', uploadUrl, true);
            xhr.setRequestHeader('Content-Type', file.type);
            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressText.textContent = `${percentComplete}% (Fichier ${i + 1}/${files.length})`;
                }
            };
            xhr.onload = () => {
                if (xhr.status === 200) {
                    // 3. Informer notre BDD que le fichier est uploadé
                    authenticatedFetch('/.netlify/functions/create-item', {
                        method: 'POST',
                        body: JSON.stringify({ path: filePath, type: 'file' })
                    }).then(resolve).catch(reject);
                } else {
                    reject('Erreur S3: ' + xhr.statusText);
                }
            };
            xhr.onerror = () => reject('Erreur réseau');
            xhr.send(file);
        });
    }

    alert('Upload terminé !');
    progressContainer.style.display = 'none';
    loadTree();
});


document.getElementById("createFolderForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const newFolderName = document.getElementById("newFolder").value;
    const destinationFolder = document.getElementById("folderSelect").value;
    const fullPath = destinationFolder ? `${destinationFolder}/${newFolderName}` : newFolderName;

    try {
        const response = await authenticatedFetch('/.netlify/functions/create-item', {
            method: 'POST',
            body: JSON.stringify({ path: fullPath, type: 'folder' })
        });
        await handleResponse(response, "Dossier créé !");
    } catch(error) {/* géré par handleResponse */}
});


async function deleteItem(path, type) {
    if (!confirm(`Supprimer ${type} : ${path} ?`)) return;
    try {
        const response = await authenticatedFetch('/.netlify/functions/delete-item', {
            method: 'POST',
            body: JSON.stringify({ path, type })
        });
        await handleResponse(response, "Élément supprimé !");
    } catch(error) {/* géré par handleResponse */}
}

async function renameItem(oldPath, type) {
    const oldName = oldPath.split('/').pop();
    const newName = prompt('Nouveau nom:', oldName);
    if (!newName || newName === oldName) return;
    
    const parentPath = oldPath.substring(0, oldPath.lastIndexOf('/'));
    
    try {
        const response = await authenticatedFetch('/.netlify/functions/move-item', {
            method: 'POST',
            body: JSON.stringify({ source: oldPath, destination: parentPath, type })
        });
        // Note: L'API de déplacement/renommage est complexe. Ici, nous réutilisons `move-item`.
        // Une version plus complète aurait une fonction `rename-item` dédiée.
        // Cette implémentation est une simplification.
        await handleResponse(response, "Élément renommé !");

    } catch (error) { /* géré */ }
}

// Le reste de vos fonctions JS (toggleFolder, openMoveModal, lightbox...)
// peut être collé ici, il est principalement lié au DOM et n'a pas besoin de grosses modifications.
// ...

// ======================= GESTION DE L'AUTHENTIFICATION ========================
netlifyIdentity.on('init', (user) => {
    if (user) {
        document.getElementById('app').style.display = 'block';
        window.user = user;
        loadTree();
    } else {
        document.getElementById('app').style.display = 'none';
    }
});

netlifyIdentity.on('login', (loggedInUser) => {
    document.getElementById('app').style.display = 'block';
    window.user = loggedInUser;
    netlifyIdentity.close();
    loadTree();
});

netlifyIdentity.on('logout', () => {
    document.getElementById('app').style.display = 'none';
    window.user = null;
    document.getElementById('fileTree').innerHTML = "";
});

</script>
</body>
</html>